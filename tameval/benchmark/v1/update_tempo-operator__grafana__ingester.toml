[meta]
task = "update"
scenario = "update_test"

[lang_info]
lang = "Go"
go_version = "1.23.0"

[repo_info]
repository = "grafana/tempo-operator"
sha = "3b270ff092b32dbff273ff7e5972ea2ddddc2da9"

[run_info]
docker_image = "golang:1.23"
volumes_to_mount = [ "{proj_path}:/app", "{host}/.m2:/.m2", "{host}/.cache/pip:/.pip_cache", "{host}/.cache/go-build:/.go_cache", "{proj_path}/_HOME_/go:/go",]
docker_wrap = "sudo docker run --rm -w /app -v {proj_path}:/app -v {host}/.m2:/.m2 -v {host}/.cache/pip:/.pip_cache -v {host}/.cache/go-build:/.go_cache -v {proj_path}/_HOME_/go:/go {img} sh -c '{cmd}'"
env = []
prebuild_command = "go mod download && go install github.com/zimmski/go-mutesting/cmd/go-mutesting@latest && go install github.com/jstemmer/go-junit-report@latest"
test_run_command = "go test -v -failfast -coverprofile=coverage.out internal/manifests/ingester/ingester.go internal/manifests/ingester/ingester_test.go 2>&1 && go tool cover -func=coverage.out"
mutation_run_command = "timeout {timeout} go-mutesting internal/manifests/ingester/ingester.go"
coverage_report_path = "coverage.out"
coverage_report_type = "go_cover"
mutation_report_path = "mutation_report.txt"
mutation_report_type = "go-mutesting"

[coverage]
coverage = 0
original_coverage = 87.0
mutation_kill_rate = nan
original_mutation_kill_rate = nan
covered_lines = []
missed_lines = []

[input_info]
test_file_path = "internal/manifests/ingester/ingester_test.go"
focal_file_path = "internal/manifests/ingester/ingester.go"
test_file_url = "https://github.com/grafana/tempo-operator/blob/3b270ff092b32dbff273ff7e5972ea2ddddc2da9/internal/manifests/ingester/ingester_test.go"
focal_file_url = "https://github.com/grafana/tempo-operator/blob/3b270ff092b32dbff273ff7e5972ea2ddddc2da9/internal/manifests/ingester/ingester.go"
first_commit_date = "2022-09-28"
last_commit_date = "2025-02-07"
test_file_content = "package ingester\n\nimport (\n\t\"testing\"\n\n\t\"github.com/stretchr/testify/assert\"\n\t\"github.com/stretchr/testify/require\"\n\tv1 \"k8s.io/api/apps/v1\"\n\tcorev1 \"k8s.io/api/core/v1\"\n\t\"k8s.io/apimachinery/pkg/api/resource\"\n\tmetav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\"\n\tk8slabels \"k8s.io/apimachinery/pkg/labels\"\n\t\"k8s.io/apimachinery/pkg/util/intstr\"\n\n\tconfigv1alpha1 \"github.com/grafana/tempo-operator/apis/config/v1alpha1\"\n\t\"github.com/grafana/tempo-operator/apis/tempo/v1alpha1\"\n\t\"github.com/grafana/tempo-operator/internal/manifests/manifestutils\"\n)\n\nfunc TestBuildIngester(t *testing.T) {\n\n\ttests := []struct {\n\t\tname                     string\n\t\tinstanceAddrType         v1alpha1.InstanceAddrType\n\t\texpectedContainerEnvVars []corev1.EnvVar\n\t}{\n\t\t{\n\t\t\tname: \"default\",\n\t\t\texpectedContainerEnvVars: []corev1.EnvVar{\n\t\t\t\t{\n\t\t\t\t\tName: \"S3_SECRET_KEY\",\n\t\t\t\t\tValueFrom: &corev1.EnvVarSource{\n\t\t\t\t\t\tSecretKeyRef: &corev1.SecretKeySelector{\n\t\t\t\t\t\t\tKey: \"access_key_secret\",\n\t\t\t\t\t\t\tLocalObjectReference: corev1.LocalObjectReference{\n\t\t\t\t\t\t\t\tName: \"test-storage-secret\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t}, {\n\t\t\t\t\tName: \"S3_ACCESS_KEY\",\n\t\t\t\t\tValueFrom: &corev1.EnvVarSource{\n\t\t\t\t\t\tSecretKeyRef: &corev1.SecretKeySelector{\n\t\t\t\t\t\t\tKey: \"access_key_id\",\n\t\t\t\t\t\t\tLocalObjectReference: corev1.LocalObjectReference{\n\t\t\t\t\t\t\t\tName: \"test-storage-secret\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t\t{\n\t\t\tname:             \"set InstanceAddrType to PodIP\",\n\t\t\tinstanceAddrType: v1alpha1.InstanceAddrPodIP,\n\t\t\texpectedContainerEnvVars: []corev1.EnvVar{\n\t\t\t\t{\n\t\t\t\t\tName: \"S3_SECRET_KEY\",\n\t\t\t\t\tValueFrom: &corev1.EnvVarSource{\n\t\t\t\t\t\tSecretKeyRef: &corev1.SecretKeySelector{\n\t\t\t\t\t\t\tKey: \"access_key_secret\",\n\t\t\t\t\t\t\tLocalObjectReference: corev1.LocalObjectReference{\n\t\t\t\t\t\t\t\tName: \"test-storage-secret\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t}, {\n\t\t\t\t\tName: \"S3_ACCESS_KEY\",\n\t\t\t\t\tValueFrom: &corev1.EnvVarSource{\n\t\t\t\t\t\tSecretKeyRef: &corev1.SecretKeySelector{\n\t\t\t\t\t\t\tKey: \"access_key_id\",\n\t\t\t\t\t\t\tLocalObjectReference: corev1.LocalObjectReference{\n\t\t\t\t\t\t\t\tName: \"test-storage-secret\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tName: \"HASH_RING_INSTANCE_ADDR\",\n\t\t\t\t\tValueFrom: &corev1.EnvVarSource{\n\t\t\t\t\t\tFieldRef: &corev1.ObjectFieldSelector{\n\t\t\t\t\t\t\tAPIVersion: \"v1\",\n\t\t\t\t\t\t\tFieldPath:  \"status.podIP\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}\n\tfor _, ts := range tests {\n\t\tt.Run(ts.name, func(t *testing.T) {\n\t\t\tstorageClassName := \"default\"\n\t\t\tfilesystem := corev1.PersistentVolumeFilesystem\n\n\t\t\tinstanceAddrType := v1alpha1.InstanceAddrDefault\n\t\t\tif ts.instanceAddrType != \"\" {\n\t\t\t\tinstanceAddrType = ts.instanceAddrType\n\t\t\t}\n\n\t\t\tobjects, err := BuildIngester(manifestutils.Params{Tempo: v1alpha1.TempoStack{\n\t\t\t\tObjectMeta: metav1.ObjectMeta{\n\t\t\t\t\tName:      \"test\",\n\t\t\t\t\tNamespace: \"project1\",\n\t\t\t\t},\n\t\t\t\tSpec: v1alpha1.TempoStackSpec{\n\t\t\t\t\tImages: configv1alpha1.ImagesSpec{\n\t\t\t\t\t\tTempo: \"docker.io/grafana/tempo:1.5.0\",\n\t\t\t\t\t},\n\t\t\t\t\tServiceAccount: \"tempo-test-serviceaccount\",\n\t\t\t\t\tStorage: v1alpha1.ObjectStorageSpec{\n\t\t\t\t\t\tSecret: v1alpha1.ObjectStorageSecretSpec{\n\t\t\t\t\t\t\tName: \"test-storage-secret\",\n\t\t\t\t\t\t\tType: \"s3\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tStorageSize:      resource.MustParse(\"10Gi\"),\n\t\t\t\t\tStorageClassName: &storageClassName,\n\t\t\t\t\tTemplate: v1alpha1.TempoTemplateSpec{\n\t\t\t\t\t\tIngester: v1alpha1.TempoComponentSpec{\n\t\t\t\t\t\t\tNodeSelector: map[string]string{\"a\": \"b\"},\n\t\t\t\t\t\t\tTolerations: []corev1.Toleration{\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tKey: \"c\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tResources: v1alpha1.Resources{\n\t\t\t\t\t\tTotal: &corev1.ResourceRequirements{\n\t\t\t\t\t\t\tLimits: corev1.ResourceList{\n\t\t\t\t\t\t\t\tcorev1.ResourceCPU:    resource.MustParse(\"1000m\"),\n\t\t\t\t\t\t\t\tcorev1.ResourceMemory: resource.MustParse(\"2Gi\"),\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tHashRing: v1alpha1.HashRingSpec{\n\t\t\t\t\t\tMemberList: v1alpha1.MemberListSpec{\n\t\t\t\t\t\t\tInstanceAddrType: instanceAddrType,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t}})\n\t\t\trequire.NoError(t, err)\n\n\t\t\tlabels := manifestutils.ComponentLabels(\"ingester\", \"test\")\n\t\t\tannotations := manifestutils.CommonAnnotations(\"\")\n\t\t\tassert.Equal(t, 2, len(objects))\n\n\t\t\tassert.Equal(t, &v1.StatefulSet{\n\t\t\t\tObjectMeta: metav1.ObjectMeta{\n\t\t\t\t\tName:      \"tempo-test-ingester\",\n\t\t\t\t\tNamespace: \"project1\",\n\t\t\t\t\tLabels:    labels,\n\t\t\t\t},\n\t\t\t\tSpec: v1.StatefulSetSpec{\n\t\t\t\t\tSelector: &metav1.LabelSelector{\n\t\t\t\t\t\tMatchLabels: labels,\n\t\t\t\t\t},\n\t\t\t\t\tPodManagementPolicy: v1.ParallelPodManagement,\n\t\t\t\t\tTemplate: corev1.PodTemplateSpec{\n\n\t\t\t\t\t\tObjectMeta: metav1.ObjectMeta{\n\t\t\t\t\t\t\tLabels:      k8slabels.Merge(labels, map[string]string{\"tempo-gossip-member\": \"true\"}),\n\t\t\t\t\t\t\tAnnotations: annotations,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tSpec: corev1.PodSpec{\n\t\t\t\t\t\t\tServiceAccountName: \"tempo-test-serviceaccount\",\n\t\t\t\t\t\t\tNodeSelector:       map[string]string{\"a\": \"b\"},\n\t\t\t\t\t\t\tTolerations: []corev1.Toleration{\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tKey: \"c\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tAffinity: manifestutils.DefaultAffinity(labels),\n\t\t\t\t\t\t\tContainers: []corev1.Container{\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tName:  \"tempo\",\n\t\t\t\t\t\t\t\t\tImage: \"docker.io/grafana/tempo:1.5.0\",\n\t\t\t\t\t\t\t\t\tArgs: []string{\"-target=ingester\",\n\t\t\t\t\t\t\t\t\t\t\"-config.file=/conf/tempo.yaml\",\n\t\t\t\t\t\t\t\t\t\t\"-log.level=info\",\n\t\t\t\t\t\t\t\t\t\t\"-config.expand-env=true\",\n\t\t\t\t\t\t\t\t\t\t\"--storage.trace.s3.secret_key=$(S3_SECRET_KEY)\",\n\t\t\t\t\t\t\t\t\t\t\"--storage.trace.s3.access_key=$(S3_ACCESS_KEY)\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tEnv: ts.expectedContainerEnvVars,\n\t\t\t\t\t\t\t\t\tVolumeMounts: []corev1.VolumeMount{\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tName:      manifestutils.ConfigVolumeName,\n\t\t\t\t\t\t\t\t\t\t\tMountPath: \"/conf\",\n\t\t\t\t\t\t\t\t\t\t\tReadOnly:  true,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tName:      dataVolumeName,\n\t\t\t\t\t\t\t\t\t\t\tMountPath: \"/var/tempo\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tPorts: []corev1.ContainerPort{\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tName:          manifestutils.HttpMemberlistPortName,\n\t\t\t\t\t\t\t\t\t\t\tContainerPort: manifestutils.PortMemberlist,\n\t\t\t\t\t\t\t\t\t\t\tProtocol:      corev1.ProtocolTCP,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tName:          manifestutils.HttpPortName,\n\t\t\t\t\t\t\t\t\t\t\tContainerPort: manifestutils.PortHTTPServer,\n\t\t\t\t\t\t\t\t\t\t\tProtocol:      corev1.ProtocolTCP,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tName:          manifestutils.GrpcPortName,\n\t\t\t\t\t\t\t\t\t\t\tContainerPort: manifestutils.PortGRPCServer,\n\t\t\t\t\t\t\t\t\t\t\tProtocol:      corev1.ProtocolTCP,\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tReadinessProbe: &corev1.Probe{\n\t\t\t\t\t\t\t\t\t\tProbeHandler: corev1.ProbeHandler{\n\t\t\t\t\t\t\t\t\t\t\tHTTPGet: &corev1.HTTPGetAction{\n\t\t\t\t\t\t\t\t\t\t\t\tScheme: corev1.URISchemeHTTP,\n\t\t\t\t\t\t\t\t\t\t\t\tPath:   manifestutils.TempoReadinessPath,\n\t\t\t\t\t\t\t\t\t\t\t\tPort:   intstr.FromString(manifestutils.HttpPortName),\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tInitialDelaySeconds: 15,\n\t\t\t\t\t\t\t\t\t\tTimeoutSeconds:      1,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tResources: corev1.ResourceRequirements{\n\t\t\t\t\t\t\t\t\t\tLimits: corev1.ResourceList{\n\t\t\t\t\t\t\t\t\t\t\tcorev1.ResourceCPU:    *resource.NewMilliQuantity(380, resource.BinarySI),\n\t\t\t\t\t\t\t\t\t\t\tcorev1.ResourceMemory: *resource.NewQuantity(1073741824, resource.BinarySI),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tRequests: corev1.ResourceList{\n\t\t\t\t\t\t\t\t\t\t\tcorev1.ResourceCPU:    *resource.NewMilliQuantity(114, resource.BinarySI),\n\t\t\t\t\t\t\t\t\t\t\tcorev1.ResourceMemory: *resource.NewQuantity(322122560, resource.BinarySI),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tSecurityContext: manifestutils.TempoContainerSecurityContext(),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tVolumes: []corev1.Volume{\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tName: manifestutils.ConfigVolumeName,\n\t\t\t\t\t\t\t\t\tVolumeSource: corev1.VolumeSource{\n\t\t\t\t\t\t\t\t\t\tConfigMap: &corev1.ConfigMapVolumeSource{\n\t\t\t\t\t\t\t\t\t\t\tLocalObjectReference: corev1.LocalObjectReference{\n\t\t\t\t\t\t\t\t\t\t\t\tName: \"tempo-test\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tVolumeClaimTemplates: []corev1.PersistentVolumeClaim{\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tObjectMeta: metav1.ObjectMeta{\n\t\t\t\t\t\t\t\tName: dataVolumeName,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tSpec: corev1.PersistentVolumeClaimSpec{\n\t\t\t\t\t\t\t\tAccessModes: []corev1.PersistentVolumeAccessMode{corev1.ReadWriteOnce},\n\t\t\t\t\t\t\t\tResources: corev1.VolumeResourceRequirements{\n\t\t\t\t\t\t\t\t\tRequests: corev1.ResourceList{\n\t\t\t\t\t\t\t\t\t\tcorev1.ResourceStorage: resource.MustParse(\"10Gi\"),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tStorageClassName: &storageClassName,\n\t\t\t\t\t\t\t\tVolumeMode:       &filesystem,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t}, objects[0])\n\t\t\tassert.Equal(t, &corev1.Service{\n\t\t\t\tObjectMeta: metav1.ObjectMeta{\n\t\t\t\t\tName:      \"tempo-test-ingester\",\n\t\t\t\t\tNamespace: \"project1\",\n\t\t\t\t\tLabels:    labels,\n\t\t\t\t},\n\t\t\t\tSpec: corev1.ServiceSpec{\n\t\t\t\t\tPorts: []corev1.ServicePort{\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tName:       manifestutils.HttpPortName,\n\t\t\t\t\t\t\tProtocol:   corev1.ProtocolTCP,\n\t\t\t\t\t\t\tPort:       manifestutils.PortHTTPServer,\n\t\t\t\t\t\t\tTargetPort: intstr.FromString(manifestutils.HttpPortName),\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tName:       manifestutils.GrpcPortName,\n\t\t\t\t\t\t\tProtocol:   corev1.ProtocolTCP,\n\t\t\t\t\t\t\tPort:       manifestutils.PortGRPCServer,\n\t\t\t\t\t\t\tTargetPort: intstr.FromString(manifestutils.GrpcPortName),\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tSelector: labels,\n\t\t\t\t},\n\t\t\t}, objects[1])\n\t\t})\n\t}\n}\n\nfunc TestOverrideResources(t *testing.T) {\n\toverrideResources := corev1.ResourceRequirements{\n\t\tLimits: corev1.ResourceList{\n\t\t\tcorev1.ResourceCPU:    resource.MustParse(\"500m\"),\n\t\t\tcorev1.ResourceMemory: resource.MustParse(\"2Gi\"),\n\t\t},\n\t}\n\n\tobjects, err := BuildIngester(manifestutils.Params{Tempo: v1alpha1.TempoStack{\n\t\tObjectMeta: metav1.ObjectMeta{\n\t\t\tName:      \"test\",\n\t\t\tNamespace: \"project1\",\n\t\t},\n\t\tSpec: v1alpha1.TempoStackSpec{\n\t\t\tImages: configv1alpha1.ImagesSpec{\n\t\t\t\tTempo: \"docker.io/grafana/tempo:1.5.0\",\n\t\t\t},\n\t\t\tServiceAccount: \"tempo-test-serviceaccount\",\n\t\t\tStorage: v1alpha1.ObjectStorageSpec{\n\t\t\t\tSecret: v1alpha1.ObjectStorageSecretSpec{\n\t\t\t\t\tName: \"test-storage-secret\",\n\t\t\t\t\tType: \"s3\",\n\t\t\t\t},\n\t\t\t},\n\t\t\tStorageSize: resource.MustParse(\"10Gi\"),\n\t\t\tTemplate: v1alpha1.TempoTemplateSpec{\n\t\t\t\tIngester: v1alpha1.TempoComponentSpec{\n\t\t\t\t\tNodeSelector: map[string]string{\"a\": \"b\"},\n\t\t\t\t\tTolerations: []corev1.Toleration{\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tKey: \"c\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tResources: &overrideResources,\n\t\t\t\t},\n\t\t\t},\n\t\t\tResources: v1alpha1.Resources{\n\t\t\t\tTotal: &corev1.ResourceRequirements{\n\t\t\t\t\tLimits: corev1.ResourceList{\n\t\t\t\t\t\tcorev1.ResourceCPU:    resource.MustParse(\"1000m\"),\n\t\t\t\t\t\tcorev1.ResourceMemory: resource.MustParse(\"2Gi\"),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}})\n\trequire.NoError(t, err)\n\tss, ok := objects[0].(*v1.StatefulSet)\n\trequire.True(t, ok)\n\tassert.Equal(t, ss.Spec.Template.Spec.Containers[0].Resources, overrideResources)\n}"
